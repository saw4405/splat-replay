# Splat Replay ユーザーガイド

このガイドでは、Splat Replay を使ってスプラトゥーンのゲームプレイを自動録画し、YouTube にアップロードする方法について説明します。録画からアップロード、サムネイル作成まで一連の流れを自動化することで、プレイに集中しながら記録を残せます。

## 目次

1. [システム要件](#1-システム要件)
2. [インストール手順](#2-インストール手順)
3. [初期設定](#3-初期設定)
4. [使用方法](#4-使用方法)
5. [動画のアップロード仕様](#5-動画のアップロード仕様)
6. [カスタマイズ設定](#6-カスタマイズ設定)
7. [トラブルシューティング](#7-トラブルシューティング)
8. [よくある質問](#8-よくある質問)
9. [メンテナンス情報](#9-メンテナンス情報)

## 1. システム要件

### 1.1. ハードウェア要件

- **PC**: Windows 11
- **キャプチャーボード**: 1080p/60fps 対応推奨
- **マイク**: 音声認識機能を使用する場合（オプション）
- **Nintendo Switch**: ドックに接続された状態

### 1.2. ソフトウェア要件

- **OS**: Windows 11
- **Python**: 3.13 以上
- **uv**: パッケージ管理用
- **OBS Studio**: 28.0 以上（WebSocket 機能を使用するため）
- **FFmpeg**: 動画処理用
- **Tesseract**: OCR（文字認識）用
- **イカモドキフォント**: サムネイル生成用
- **Groq API キー**: 音声認識・文字起こし機能を使用する場合

## 2. インストール手順

### 2.1. 前提ソフトウェアのインストール

#### 2.1.1. Python 3 のインストール

1. [Python 公式サイト](https://www.python.org/downloads/)から Python 3.13 以上をダウンロード
2. インストーラを実行し、**「Add Python to PATH」オプションを必ずチェック**してインストール
3. インストール完了後、コマンドプロンプトで`python --version`を実行して確認

#### 2.1.2. uv のインストール

1. コマンドプロンプトを管理者権限で開き、以下のコマンドを実行:
   ```
   pip install uv
   ```
2. インストール後、`uv --version`で確認

#### 2.1.3. OBS Studio のインストール

1. [OBS Studio 公式サイト](https://obsproject.com/)から最新版をダウンロード
2. インストーラを実行し、デフォルト設定でインストール
3. 初回起動時の最適化ウィザードは「録画向け設定」を選択

#### 2.1.4. FFmpeg のインストール

1. [FFmpeg 公式サイト](https://ffmpeg.org/download.html)から最新の Windows 用ビルドをダウンロード
2. ダウンロードした zip ファイルを解凍し、例えば`C:\ffmpeg`などの場所に配置
3. システム環境変数 PATH に`C:\ffmpeg\bin`を追加
4. コマンドプロンプトで`ffmpeg -version`を実行して確認

#### 2.1.5. Tesseract のインストール

1. [UB-Mannheim のリポジトリ](https://github.com/UB-Mannheim/tesseract/wiki)から最新の Tesseract-OCR をダウンロード
2. インストーラを実行し、「Additional language data」で「English」を選択
3. インストール後、以下の追加データをダウンロード:
   - [best 版 eng データ](https://github.com/tesseract-ocr/tessdata_best/raw/master/eng.traineddata)
   - ダウンロードしたファイルを`C:\Program Files\Tesseract-OCR\tessdata`に上書き保存

#### 2.1.6. イカモドキフォントのダウンロード

1. [イカモドキフォント配布ページ](https://web.archive.org/web/20150906013956/http://aramugi.com/?page_id=807)からフォントをダウンロード
2. ダウンロードしたフォントファイルをインストールせずに保管（後で配置します）

#### 2.1.7. Groq API キーの取得（音声認識機能を使用する場合のみ）

1. [Groq 公式サイト](https://console.groq.com/)でアカウント作成
2. API キーを生成して安全な場所に保存

#### 2.1.8. YouTube API 認証設定

1. [Google Cloud Console](https://console.cloud.google.com/)で新しいプロジェクトを作成
2. YouTube Data API v3 を有効化
3. 認証情報ページで「OAuth 2.0 クライアント ID」を作成:
   - アプリケーションの種類: デスクトップアプリケーション
   - リダイレクト URI: `http://localhost:8080/`
4. 作成した認証情報の「JSON をダウンロード」をクリックし、`client_secrets.json`として保存
5. YouTube チャンネルの確認と登録を完了する

### 2.2. アプリケーションのインストール

#### 2.2.1. リポジトリのクローン

```powershell
git clone https://github.com/yourusername/splat-replay.git
cd splat-replay
```

#### 2.2.2. 依存パッケージのインストール

```powershell
uv venv
.venv\Scripts\activate
uv sync
```

#### 2.2.3. イカモドキフォントの配置

1. ダウンロードしたイカモドキフォントを`assets\thumbnail`フォルダにコピー

#### 2.2.4. YouTube API 認証情報の配置

1. ダウンロードした`client_secrets.json`をリポジトリのルートディレクトリに配置

## 3. 初期設定

### 3.1. 環境変数の設定

1. リポジトリ内の`.example.env`ファイルを`.env`にコピー
2. テキストエディタで`.env`ファイルを開き、以下の重要設定を行う:

```
# デバイス設定
CAPTURE_DEVICE_INDEX=1        # キャプチャーデバイスのインデックス（後述のテストで確認）
CAPTURE_DEVICE_NAME=HD60 S+   # キャプチャーデバイス名
MIC_DEVICE=マイク (Realtek)   # 使用するマイクデバイス名（オプション）

# OBS設定
OBS_WS_HOST=localhost         # OBS WebSocketホスト
OBS_WS_PORT=4455              # OBS WebSocketポート
OBS_WS_PASSWORD=yourpassword  # OBS WebSocketパスワード

# アップロード設定
UPLOAD_MODE=AUTO              # AUTO: Switch電源OFFで自動アップロード, PERIODIC: 定時アップロード
UPLOAD_TIME=23:00             # PERIODICモード時のアップロード時刻（24時間表記）

# API設定
GROQ_API_KEY=gsk_xxxxx        # 音声認識機能を使用する場合のGroq APIキー
```

### 3.2. キャプチャーデバイスの確認

接続されているキャプチャーデバイスのインデックスを確認:

```powershell
python src\test_capture_device.py
```

表示された一覧から、使用するキャプチャーデバイスのインデックスを確認し、`.env`の`CAPTURE_DEVICE_INDEX`に設定。

### 3.3. OBS Studio の設定

1. OBS Studio を起動
2. ソースを追加:
   - 「ソース」パネルの「+」ボタン →「映像キャプチャデバイス」
   - キャプチャーデバイスを選択し、解像度を 1080p、フレームレートを 60fps に設定
3. WebSocket 設定:
   - 「ツール」メニュー →「WebSocket Server Settings」
   - 「WebSocket server 有効」にチェック
   - サーバーポート: `4455`（デフォルト）
   - パスワードを設定し、`.env`ファイルの`OBS_WS_PASSWORD`に同じ値を設定
4. 出力設定:
   - 「設定」→「出力」
   - 出力モード: 詳細
   - エンコーダ: NVIDIA NVENC H.264（NVIDIA GPU の場合）
   - レート制御: CQP
   - CQ 値: 18（低いほど高品質）
   - キーフレーム間隔: 2
   - プリセット: 品質優先
   - プロファイル: 高
   - 録画形式: mp4

### 3.4. YouTube 初回認証

1. アプリケーションを初めて起動すると、YouTube 認証のためにブラウザが開きます
2. Google アカウントでログインし、必要な権限を許可
3. 「アクセスを許可しました。このタブを閉じて先に進んでください。」と表示されたらブラウザタブを閉じる
4. 認証情報が`token.pickle`ファイルに自動保存される

## 4. 使用方法

### 4.1. システムの起動

1. Nintendo Switch をドックに接続し、キャプチャーボードを通して PC に接続
2. リポジトリルートにある`start.bat`をダブルクリックしてアプリケーションを起動
   - コマンドプロンプトウィンドウが開き、ステータス情報が表示される
   - 初回またはトークン期限切れ時は、YouTube 認証が必要

### 4.2. バトル録画の仕組み

- システムはバックグラウンドで動作し、画面を常時監視
- スプラトゥーンのバトル開始を自動検出すると録画を開始
- バトル終了時に自動的に録画を停止し、メタデータ（ルール、ステージ、勝敗など）を抽出
- バトル情報を含む動画ファイルが自動的に作成される
- 連続したバトルはそれぞれ個別のファイルとして記録される

### 4.3. アップロード動作の種類

#### 4.3.1. 自動アップロードモード（デフォルト）

- Nintendo Switch の電源を OFF にすると自動的にアップロード処理が開始
- （設定に応じて）アップロード完了後に PC をスリープ

#### 4.3.2. 定期アップロードモード

- `.env`ファイルで`UPLOAD_MODE=PERIODIC`に設定した場合
- 指定時刻（`UPLOAD_TIME`）になると自動的にアップロード処理が実行

### 4.4. システムの停止

- 通常の停止: アプリケーションウィンドウを閉じる（× ボタンをクリック）
- 強制停止が必要な場合: Ctrl+C キーを押す

## 5. 動画のアップロード仕様

### 5.1. 動画のグルーピング

録画されたバトルは以下のルールでグループ化され YouTube にアップロードされます:

- 同じ日付のバトル
- 同じ 2 時間枠内でのプレイ（例: 21-23 時）
- 同じマッチタイプ（ナワバリバトル、バンカラマッチなど）
- 同じルール（ガチエリア、ガチヤグラなど）

### 5.2. 動画のタイトルと説明

- **タイトル形式**:

  ```
  {BATTLE}({RATE}) {RULE} {WIN}勝{LOSE}敗 {DAY} {SCHEDULE}時～
  ```

  例: `Xマッチ(XP19-20) ガチヤグラ 5勝3敗 '25.05.17 21時～`

- **説明文形式**:
  ```
  レート
  00:00:00 WIN ステージ名
  00:10:25 LOSE ステージ名
  ...
  ```

### 5.3. サムネイル

- 自動生成されるサムネイルには以下の情報が含まれます:
  - バトル種別（X マッチ、ナワバリなど）
  - ルール（ガチアサリ、ガチエリアなど）
  - レート情報（該当する場合）
  - 勝敗数（○ 勝 × 敗の表示）
  - プレイしたステージの代表的な画像

## 6. カスタマイズ設定

### 6.1. .env ファイルの詳細設定

`.env`ファイルでは以下の追加設定をカスタマイズできます:

- キャプチャーデバイスの設定
- OBS の接続設定
- アップロードモードと時刻
- タイトルと説明文のテンプレート
- 音量調整の設定

### 6.2. 用語集の更新

音声認識の精度を向上させるには、スプラトゥーン関連の専門用語を登録します:

1. `assets/glossary.txt`ファイルをテキストエディタで開く
2. 各行に 1 つのスプラトゥーン用語を追加:
   ```
   ガチエリア
   ガチヤグラ
   ガチホコバトル
   ガチアサリ
   ナワバリバトル
   スペシャル
   インク
   ```

### 6.3. サムネイル画像のカスタマイズ

サムネイルをカスタマイズする方法:

1. 1920x1080 サイズの PNG 画像を作成
2. `assets\thumbnail`フォルダに`thumbnail_overlay.png`として保存

- **透過あり**の場合: 透過部分に自動生成サムネイルが表示され、非透過部分に独自の装飾が表示される
- **透過なし**の場合: 完全にカスタムサムネイルで置き換えられる（自動生成は無効化）

**ヒント**: 自分のロゴやチャンネルアイコンを透過付きで配置するのがおすすめです。

## 7. トラブルシューティング

### 7.1. Switch の電源 OFF を検知できない

**解決策**:

1. Switch 電源を OFF にした状態の画面をキャプチャ
2. OBS でスクリーンショットを取得
3. 画像を`assets\templates`フォルダに`power_off.png`として保存
